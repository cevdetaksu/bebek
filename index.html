<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bizim 3D Bebeğimiz</title>

<style>
body{
  margin:0;
  background:linear-gradient(135deg,#1e1e2f,#2d2d44);
  font-family:Arial;
  color:white;
  text-align:center;
}
#ui{
  position:absolute;
  top:10px;
  width:100%;
}
button{
  padding:8px 12px;
  margin:4px;
  border:none;
  border-radius:8px;
  background:#6c5ce7;
  color:white;
}
.bar{
  height:10px;
  background:#444;
  margin:5px 20px;
  border-radius:5px;
}
.fill{
  height:100%;
  border-radius:5px;
}
canvas{
  display:block;
}
</style>
</head>
<body>

<div id="ui">
  <div>Yaş: <span id="age">0</span> ay</div>

  <div class="bar"><div id="hungerBar" class="fill" style="background:#ff7675;width:100%"></div></div>
  <div class="bar"><div id="hygieneBar" class="fill" style="background:#74b9ff;width:100%"></div></div>
  <div class="bar"><div id="happyBar" class="fill" style="background:#55efc4;width:100%"></div></div>

  <button onclick="feed()">Besle</button>
  <button onclick="clean()">Duş</button>
  <button onclick="play()">Oyna</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCmLDHsE_HnPfULTkKo43caR8xfrhJo7A0",
  authDomain: "bebek-bf416.firebaseapp.com",
  projectId: "bebek-bf416",
  storageBucket: "bebek-bf416.firebasestorage.app",
  messagingSenderId: "636452743271",
  appId: "1:636452743271:web:23327585b91be6f714ccc2"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore();
const ref = doc(db,"families","main");

// 3D SAHNE
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x2d2d44);

const camera = new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,1000);
camera.position.z = 5;

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth,window.innerHeight);
document.body.appendChild(renderer.domElement);

const light = new THREE.DirectionalLight(0xffffff,1);
light.position.set(5,5,5);
scene.add(light);
scene.add(new THREE.AmbientLight(0xffffff,0.6));

const skin = new THREE.MeshStandardMaterial({color:0xffd1b3});
let eyeMaterial = new THREE.MeshStandardMaterial({color:0x000000});
const cloth = new THREE.MeshStandardMaterial({color:0x6c5ce7});

const head = new THREE.Mesh(new THREE.SphereGeometry(1,32,32),skin);
scene.add(head);

const body = new THREE.Mesh(new THREE.CylinderGeometry(0.8,1,1.5,32),cloth);
body.position.y = -1.8;
scene.add(body);

const eye1 = new THREE.Mesh(new THREE.SphereGeometry(0.15,32,32),eyeMaterial);
eye1.position.set(-0.3,0.2,0.9);
scene.add(eye1);

const eye2 = new THREE.Mesh(new THREE.SphereGeometry(0.15,32,32),eyeMaterial);
eye2.position.set(0.3,0.2,0.9);
scene.add(eye2);

// Ağız
let mouth = new THREE.Mesh(new THREE.TorusGeometry(0.3,0.07,16,100,Math.PI), 
  new THREE.MeshStandardMaterial({color:0xff4d4d}));
mouth.position.set(0,-0.3,0.9);
scene.add(mouth);

// Animasyon
let t = 0;
function animate(){
  requestAnimationFrame(animate);
  t += 0.03;

  head.rotation.y = Math.sin(t)*0.2;
  head.position.y = Math.sin(t)*0.1;
  body.position.y = -1.8 + Math.sin(t)*0.1;

  renderer.render(scene,camera);
}
animate();

// Firebase başlat
async function init(){
  const snap = await getDoc(ref);
  if(!snap.exists()){
    await setDoc(ref,{
      age:0,
      hunger:100,
      hygiene:100,
      happiness:100,
      lastUpdate:Date.now()
    });
  }

  onSnapshot(ref, async (snap)=>{
    let data = snap.data();

    const days = Math.floor((Date.now()-data.lastUpdate)/(1000*60*60*24));
    if(days>0){
      data.age += days;
      data.hunger = Math.max(0,data.hunger-days*5);
      data.hygiene = Math.max(0,data.hygiene-days*4);
      data.happiness = Math.max(0,data.happiness-days*3);
      data.lastUpdate = Date.now();
      await updateDoc(ref,data);
    }

    updateUI(data);
  });
}
init();

function updateUI(data){
  age.innerText = data.age;
  hungerBar.style.width = data.hunger+"%";
  hygieneBar.style.width = data.hygiene+"%";
  happyBar.style.width = data.happiness+"%";

  // Yaşa göre büyüme
  const scale = 1 + data.age/24;
  head.scale.set(scale,scale,scale);
  body.scale.set(scale,scale,scale);

  // Mood yüz değişimi
  scene.remove(mouth);

  if(data.hunger<30){
    mouth = new THREE.Mesh(new THREE.TorusGeometry(0.3,0.07,16,100,Math.PI),
      new THREE.MeshStandardMaterial({color:0xff0000}));
    mouth.rotation.z = Math.PI;
  }
  else if(data.happiness>70){
    mouth = new THREE.Mesh(new THREE.TorusGeometry(0.3,0.07,16,100,Math.PI),
      new THREE.MeshStandardMaterial({color:0x00ff00}));
  }
  else{
    mouth = new THREE.Mesh(new THREE.TorusGeometry(0.3,0.07,16,100,Math.PI/2),
      new THREE.MeshStandardMaterial({color:0xffffff}));
  }

  mouth.position.set(0,-0.3*scale,0.9*scale);
  scene.add(mouth);
}

window.feed = ()=> updateDoc(ref,{hunger:100});
window.clean = ()=> updateDoc(ref,{hygiene:100});
window.play = ()=> updateDoc(ref,{happiness:100});

window.addEventListener('resize',()=>{
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth,window.innerHeight);
});
</script>

</body>
</html>
